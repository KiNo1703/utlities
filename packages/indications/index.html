<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ XLSX –∏ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ö–æ–º–∞–Ω–¥</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='80'>üïäÔ∏è</text></svg>">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="file"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .radio-group, .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            flex: 1;
        }
        .process-btn {
            background-color: #4CAF50;
        }
        .process-btn:hover {
            background-color: #45a049;
        }
        .download-btn {
            background-color: #2196F3;
            display: none;
        }
        .download-btn:hover {
            background-color: #0b7dda;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            min-height: 100px;
        }
        .instructions {
            margin: 15px 0;
            padding: 10px;
            background-color: #fffde7;
            border-left: 4px solid #ffd600;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        .notification.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ê–Ω–∞–ª–∏–∑ XLSX –∏ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ö–æ–º–∞–Ω–¥</h1>

        <div class="instructions">
            <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong> –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1E), –≤—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–∫–∞–∑–∞–Ω–∏–π, –æ—Ç–º–µ—Ç—å—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ü–£ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏, –∑–∞–≥—Ä—É–∑–∏—Ç–µ XLSX —Ñ–∞–π–ª –∏–∑ –æ—Ç—á–µ—Ç–∞ "–û—Ç—á–µ—Ç –ø–æ–ª—É—á–∞—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π" –∏ –Ω–∞–∂–º–∏—Ç–µ "–û–±—Ä–∞–±–æ—Ç–∞—Ç—å". –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–ø—É—Å–∫–∞ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ 0).
        </div>

        <div class="form-group">
            <label for="commandCode">–ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã (2 HEX-—Å–∏–º–≤–æ–ª–∞, e.g., 1E):</label>
            <input type="text" id="commandCode" maxlength="2" placeholder="1E">
        </div>

        <div class="form-group">
            <label>–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–∫–∞–∑–∞–Ω–∏–π:</label>
            <div class="radio-group">
                <input type="radio" id="halfHourly" name="interval" value="halfHourly" checked>
                <label for="halfHourly">–ß–∞—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</label>
                <input type="radio" id="hourly" name="interval" value="hourly">
                <label for="hourly">–ü–æ–ª—É—á–∞—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</label>
            </div>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="onlyMissing" checked>
                <label for="onlyMissing">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ü–£ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏</label>
            </div>
        </div>

        <div class="form-group">
            <label for="fileInput">–í—ã–±–µ—Ä–∏—Ç–µ XLSX —Ñ–∞–π–ª:</label>
            <input type="file" id="fileInput" accept=".xlsx">
        </div>

        <div class="button-group">
            <button class="process-btn" onclick="processFile()">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
            <button class="download-btn" id="downloadBtn" onclick="downloadResults()">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (TXT)</button>
        </div>

        <div class="result" id="output"></div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        let currentResult = ''; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

        function excelSerialToDate(serial) {
            if (!serial) return null;
            const utc_days = Math.floor(serial - 25569);
            const utc_value = utc_days * 86400;
            const date_info = new Date(utc_value * 1000);
            const fractional_day = serial - Math.floor(serial) + 0.0000001;
            let total_seconds = Math.floor(86400 * fractional_day);
            const seconds = total_seconds % 60;
            total_seconds -= seconds;
            const hours = Math.floor(total_seconds / (60 * 60));
            const minutes = Math.floor(total_seconds / 60) % 60;
            return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate(), hours, minutes, seconds);
        }

        function formatDate(date) {
            if (!date) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        function parseDateFromString(dateStr) {
            // dateStr –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY HH:MM
            const parts = dateStr.split(' ');
            if (parts.length !== 2) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã");
            const dateParts = parts[0].split('.');
            const timeParts = parts[1].split(':');
            if (dateParts.length !== 3 || timeParts.length !== 2) throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã");
            return {
                day: parseInt(dateParts[0], 10),
                month: parseInt(dateParts[1], 10),
                year: parseInt(dateParts[2], 10),
                hours: parseInt(timeParts[0], 10),
                minutes: parseInt(timeParts[1], 10),
                seconds: 0  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–∫—É–Ω–¥—ã –≤ 0 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            };
        }

        function encodeDataTimeSec(timeObj) {
            const { hours, minutes, seconds, day, month, year } = timeObj;
            const code1 = (year - 2000) - 24;
            const code2 = 3;

            if (code1 < 0 || code1 > 7) throw new Error("–ì–æ–¥ –≤–Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ (2024‚Äì2031)");

            const byte1 = minutes.toString(16).padStart(2, '0');
            const byte2 = hours.toString(16).padStart(2, '0');
            const byte3 = ((code1 << 5) | (day & 0x1F)).toString(16).padStart(2, '0');
            const byte4 = ((code2 << 4) | (month & 0x0F)).toString(16).padStart(2, '0');
            const byte5 = seconds.toString(16).padStart(2, '0');

            return `${byte1}${byte2}${byte3}${byte4}${byte5}`.toUpperCase();
        }

        function generateCommand(code, timeStr) {
            if (!/^[0-9A-Fa-f]{2}$/.test(code)) {
                throw new Error("–ö–æ–¥ –∫–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 2 HEX-—Å–∏–º–≤–æ–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1E).");
            }
            const timeObj = parseDateFromString(timeStr);
            const encodedBlock = encodeDataTimeSec(timeObj);
            return `14${code.toUpperCase()}${encodedBlock}${encodedBlock}`;
        }

        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const output = document.getElementById('output');
            const interval = document.querySelector('input[name="interval"]:checked').value;
            const onlyMissing = document.getElementById('onlyMissing').checked;
            const downloadBtn = document.getElementById('downloadBtn');
            const commandCode = document.getElementById('commandCode').value.trim();

            if (!commandCode) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–∞–Ω–¥—ã!', 'error');
                output.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–∞–Ω–¥—ã!';
                return;
            }

            if (!fileInput.files[0]) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!', 'error');
                output.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!';
                return;
            }

            output.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary', defval: null });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: null });

                    if (jsonData.length < 2) {
                        showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ!', 'error');
                        output.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ!';
                        return;
                    }

                    // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                    const headers = jsonData[0];
                    let snIndex = -1;
                    let timeStartIndex = -1;

                    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å S/N –∏ –Ω–∞—á–∞–ª–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
                    for (let i = 0; i < headers.length; i++) {
                        if (typeof headers[i] === 'string' && headers[i].trim() === 'S/N') {
                            snIndex = i;
                        }
                        if (typeof headers[i] === 'number' && Math.floor(headers[i]) >= 40000) {
                            if (timeStartIndex === -1) timeStartIndex = i;
                        }
                    }

                    if (snIndex === -1 || timeStartIndex === -1) {
                        showNotification('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (S/N –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏)!', 'error');
                        output.textContent = '–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (S/N –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏)!';
                        return;
                    }

                    let result = '';
                    let puCount = 0;
                    let missingPuCount = 0;

                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–π)
                    for (let rowIndex = 1; rowIndex < jsonData.length; rowIndex++) {
                        const row = jsonData[rowIndex];
                        if (!row || row.length < timeStartIndex) continue;

                        puCount++;
                        const sn = row[snIndex] ? row[snIndex].toString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

                        let missing = [];
                        for (let col = timeStartIndex; col < headers.length; col++) {
                            const value = row[col];
                            const timeSerial = headers[col];
                            const date = excelSerialToDate(timeSerial);

                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª—É—á–∞—Å–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (–º–∏–Ω—É—Ç—ã = 30) –≤ —Ä–µ–∂–∏–º–µ —á–∞—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π
                            if (interval === 'halfHourly' && date && date.getMinutes() === 30) {
                                continue;
                            }

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ (null, undefined, '')
                            if (value === null || value === undefined || value === '') {
                                missing.push(formatDate(date));
                            }
                        }

                        if (missing.length > 0) {
                            missingPuCount++;
                        }

                        if (onlyMissing && missing.length === 0) {
                            continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ü–£ –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤
                        }

                        result += `–ü–£: ${sn}\n`;
                        result += '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –∏ –∫–æ–º–∞–Ω–¥—ã:\n';

                        if (missing.length === 0) {
                            result += '–ù–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–∫–∞–∑–∞–Ω–∏–π.\n';
                        } else {
                            for (let miss of missing) {
                                try {
                                    const command = generateCommand(commandCode, miss);
                                    result += `${miss} - ${command}\n`;
                                } catch (err) {
                                    result += `${miss} - –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–∞–Ω–¥—ã: ${err.message}\n`;
                                }
                            }
                        }
                        result += '\n';
                    }

                    if (result === '') {
                        result = '–ù–µ—Ç –ü–£ —Å –ø—Ä–æ–ø—É—Å–∫–∞–º–∏ (–∏–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö).\n';
                    } else {
                        result = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ü–£: ${puCount}. –° –ø—Ä–æ–ø—É—Å–∫–∞–º–∏: ${missingPuCount}.\n\n` + result;
                    }

                    currentResult = result;
                    output.textContent = result;
                    downloadBtn.style.display = 'inline-block';
                    showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!');
                } catch (error) {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
                    output.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: ' + error.message;
                }
            };

            reader.readAsBinaryString(file);
        }

        function downloadResults() {
            if (!currentResult) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è!', 'error');
                return;
            }
            const blob = new Blob([currentResult], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'results.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞—á–∞–Ω—ã!');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.backgroundColor = type === 'error' ? '#f44336' : '#4CAF50';
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
